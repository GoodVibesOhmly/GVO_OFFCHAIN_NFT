#!/usr/bin/env bash

echo "
-------------------------------------------------------------------------------
Asset NFT Deployment Script
-------------------------------------------------------------------------------
This script deploys an instance of a Asset NFT

Prerequisites:
* This script uses the Seth Ethereum CLI which can be installed from http://dapp.tools by running 'curl https://dapp.tools/install | sh'
* If you want to use an existing deployment of the asset registry, it can be found here: https://github.com/centrifuge/go-centrifuge/blob/develop/build/configs/default_config.yaml

Please specify the following env variables:
* ASSET_MANAGER
* IDENTITY_FACTORY
"
set -ex

export CENT_ENV=${CENT_ENV:-"fulvous"}
export ETH_GAS=${ETH_GAS:-4712388}
export ETH_KEYSTORE=${ETH_KEYSTORE:-./keystore}
export ETH_RPC_URL=${ETH_RPC_URL:-"http://localhost:8545"}
export ETH_PASSWORD=${ETH_PASSWORD:-"/dev/null"}
export ETH_FROM=${ETH_FROM:-"0x89b0a86583c4444acfd71b463e0d3c55ae1412a5"}

if [ -z "$ASSET_MANAGER" ]
then
  echo "Variable ASSET_MANAGER not set"
  exit 1
fi

if [ -z "$IDENTITY_FACTORY" ]
then
  echo "Variable IDENTITY_FACTORY not set"
  exit 1
fi

dapp update
dapp build --extract
REGISTRY=$(seth send --create out/AssetNFT.bin 'AssetNFT(address, address)' $ASSET_MANAGER $IDENTITY_FACTORY)

set +ex
echo "-------------------------------------------------------------------------------"
echo "Asset NFT registry deployed to: $REGISTRY"
echo "-------------------------------------------------------------------------------"

jq --arg addr $REGISTRY --arg env $CENT_ENV '.[$env].address = $addr' addresses.json > addresses_aux.json
mv addresses_aux.json addresses.json
