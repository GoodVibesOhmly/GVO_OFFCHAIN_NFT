#!/usr/bin/env bash

echo "
-------------------------------------------------------------------------------
NFT Deployment Script
-------------------------------------------------------------------------------
This script deploys an instance of a Centrifuge NFT 

Prerequisites:
* This script uses the Seth Ethereum CLI which can be installed from http://dapp.tools by running 'curl https://dapp.tools/install | sh'
* Set the variable ASSET_REPOSITORY to an instance of the Centrifuge Asset Repository (https://github.com/centrifuge/ethereum-bridge-contracts/blob/master/src/bridge_asset.sol).
* If you want to use an existing deployment of the asset registry, it can be found here: https://github.com/centrifuge/go-centrifuge/blob/develop/build/configs/default_config.yaml

"
set -ex

export CONTRACT_NAME=${CONTRACT_NAME:-NFT}

export CENT_ENV=${CENT_ENV:-"fulvous"}
export ETH_GAS=${ETH_GAS:-4712388}
export ETH_KEYSTORE=${ETH_KEYSTORE:-./keystore}
export ETH_RPC_URL=${ETH_RPC_URL:-"http://localhost:9545"}
export ETH_PASSWORD=${ETH_PASSWORD:-"/dev/null"}
export ETH_FROM=${ETH_FROM:-"0x89b0a86583c4444acfd71b463e0d3c55ae1412a5"}

dapp update
dapp build --extract
REGISTRY=$(seth send --create out/${CONTRACT_NAME}.bin "${CONTRACT_NAME}(string memory, string memory, address)" "Centrifuge ${CONTRACT_NAME}" "${CONTRACT_NAME}" $ASSET_REPOSITORY)

jq --arg addr $REGISTRY --arg env $CENT_ENV '.[$env].address = $addr' addresses.json > addresses_aux.json
mv addresses_aux.json addresses.json

set +ex
echo "-------------------------------------------------------------------------------"
echo "NFT registry deployed to: $REGISTRY on ${CENT_ENV}"
echo "-------------------------------------------------------------------------------"
